\documentclass[final]{siamltex}

% for red MarginPars
\usepackage{color}

% for \boldsymbol
\usepackage{amsmath}
\usepackage{latexsym}
\usepackage{graphicx}
\usepackage{geometry}
\usepackage{hyperref}

% total number of floats allowed on a page
\setcounter{totalnumber}{100}

% float page fractions
\renewcommand{\topfraction}{0.9}
\renewcommand{\bottomfraction}{0.9}
\renewcommand{\textfraction}{0.2}

% MarginPar
\setlength{\marginparwidth}{0.75in}
\newcommand{\MarginPar}[1]{\marginpar{\vskip-\baselineskip\raggedright\tiny\sffamily\hrule\smallskip{\color{red}#1}\par\smallskip\hrule}}

% for non-stacked fractions
\newcommand{\sfrac}[2]{\mathchoice
  {\kern0em\raise.5ex\hbox{\the\scriptfont0 #1}\kern-.15em/
   \kern-.15em\lower.25ex\hbox{\the\scriptfont0 #2}}
  {\kern0em\raise.5ex\hbox{\the\scriptfont0 #1}\kern-.15em/
   \kern-.15em\lower.25ex\hbox{\the\scriptfont0 #2}}
  {\kern0em\raise.5ex\hbox{\the\scriptscriptfont0 #1}\kern-.2em/
   \kern-.15em\lower.25ex\hbox{\the\scriptscriptfont0 #2}}
  {#1\!/#2}}

\def\1b {{\bf 1}}
\def\bb {{\bf b}}
\def\Fb {{\bf F}}
\def\gb {{\bf g}}
\def\mb {{\bf m}}
\def\vb {{\bf v}}
\def\wb {{\bf w}}
\def\Wb {{\bf W}}
\def\xb {{\bf x}}
\def\zb {{\bf z}}

\def\chib   {\boldsymbol{\chi}}
\def\deltab {\boldsymbol{\delta}}
\def\Gammab {\boldsymbol{\Gamma}}
\def\phib   {\boldsymbol{\phi}}
\def\Phib   {\boldsymbol{\Phi}}
\def\Psib   {\boldsymbol{\Psi}}
\def\Sigmab {\boldsymbol{\Sigma}}
\def\taub   {\boldsymbol{\tau}}
\def\zetab  {\boldsymbol{\zeta}}

\def\half   {\frac{1}{2}}
\def\myhalf {\sfrac{1}{2}}

\begin{document}

%==========================================================================
% Title
%==========================================================================
\title{Low Mach Number Charged Species Notes}

\maketitle

\section{Introduction}
These are working notes for our low Mach number multicomponent charged fluid code.
The algorithm is an extension of our low Mach number multicomponent code
\cite{LowMachMulti}.  The algorithmic details are described more fully in
our previous works, in particular, the spatial discretization is described in
\cite{lowMachMixing}, and the temporal discretization for binary mixtures is
described in \cite{lowMachImplicit}.  The GMRES solver for the Stokes system
in our temporal advancement scheme is described in \cite{StokesPreconditioners}.

\section{Source Code}
There are two git repositories required to build/run the code.  BoxLib is a public
repository available on github using the command:\\ \\
{\tt git clone https://github.com/BoxLib-Codes/BoxLib.git}\\ \\
If you are not familiar with BoxLib, we recommend reading the BoxLib's User's Guide
in {\tt BoxLib/Docs}.\\

FluctHydro exists on CCSE servers and you need to contact Vince/Andy to get an account
and set up permissions on gamera.  Once you do, you can obtain the repository using:\\ \\
{\tt git clone <username>@gamera.lbl.gov:/usr/local/gitroot/FluctHydro.git}\\ \\
You will now have the following directory structures (you will actually have
more subdirectories, but below are the only directories that matter for this code):\\
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\begin{figure}[tb]
\centering
\includegraphics[width=6in]{./directory}
\caption{\label{fig:directory}Directory structure.}
\end{figure}
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\begin{itemize}

\item {\tt BoxLib/}

\begin{itemize}

\item {\tt Src/}

\begin{itemize}

\item {\tt F\_BaseLib/}

Core libraries for parallelization of structured grid data.

\item {\tt LinearSolvers/F\_MG/}

Core libraries for linear solvers (for implicit diffusion) and diffusion stencils.

\end{itemize}
\end{itemize}

\begin{itemize}

\item {\tt Tools/F\_mk/}

Make system variables and flags.

\end{itemize}
\end{itemize}

\begin{itemize}

\item {\tt FluctHydro/}

\begin{itemize}

\item {\tt HydroGrid/}

\item {\tt staggered\_grid/}

\begin{itemize}

\item {\tt exec/charged/doc/}

Contains the document you are reading right now!

\item {\tt exec/charged/test/}

This is the compilation directory.  Contains a GNUmakefile and inputs files.

\item {\tt src\_common/}

Source code shared by all our staggered grid codes.  Contains generic namelist parameters
and routines for boundary conditions, divergence, etc.

\item {\tt src\_multiSpec/}

Source code shared by all multicomponent codes.

\item {\tt src\_gmres/}

Source code for our GMRES stokes solver.

\item {\tt src\_charged/}

Source code specific to this charged fluid problem.

\end{itemize}
\end{itemize}
\end{itemize}

\subsection{Compiling and Running}
Go to {\tt FluctHydro/staggered\_grid/exec/charged/test/} and edit the 
{\tt GNUmakefile} settings to your liking (below) and simply type {\tt `make'}.\\
\begin{verbatim}
NDEBUG    :=           # 'not debug'.  use 't' for an optimized build
MPI       := t         # use 't' to build an mpi executable
OMP       :=           # use 't' to build an OpenMP threadded executable
PROF      :=           # use 't' to turn on code profiling
COMP      := gfortran  # fortran compiler
CCOMP     := gcc       # c compiler
MKVERBOSE := t         # make verbosity

\end{verbatim}
This will generate an executable whose name provides information about the build settings,
i.e., what compiler was used, whether MPI and/or OpenMP were enabled, etc.
To run the code, simply type the executable name, followed by an inputs file.

\subsection{Input Parameters}
Refer to
{\tt src\_common/probin\_common.f90}, 
{\tt src\_multiSpec/probin\_multiSpec.f90}, 
{\tt src\_gmres/probin\_gmres.f90}, and
{\tt src\_charged/probin\_charged.f90} for namelist parameters used in the
simulation and an explanation of what the parameters do.

\section{Equations}
The equations for the momentum and densities:
\begin{eqnarray}
\frac{\partial\rho\vb}{\partial t} &=& - \nabla\cdot(\rho\vb\vb) - \nabla\pi + \nabla\cdot\taub + \rho\gb - \rho(\wb^T\zb)\nabla\Phi\\
\frac{\partial\rho_i}{\partial t} &=& -\nabla\cdot(\rho_i\vb) - \nabla\cdot\Fb_i,
\end{eqnarray}
with $\rho$ the total density, $\rho_i$ the density of component $i$, $\vb$ the fluid 
velocity, $\pi$ the perturbational pressure, $\taub$ the stress tensor, $\gb$ the
gravitational acceleration, $\wb = (w_1, w_2, \cdot)$ the vector of concentrations
(mass fractions), $\zb$ the charge per unit mass, and $\Fb$ the mass fluxes.
The mass fluxes include diffusive, electrostatic, and stochastic contributions, as
shown below. The equation of state is:
\begin{equation}
\nabla\cdot\vb = -\nabla\cdot\left(\sum_i\frac{\Fb_i}{\bar\rho_i}\right) \equiv S\label{eq:S}.
\end{equation}
The deterministic part of the mass fluxes, $\overline{F}$, contains contributions from compositional
gradients, barodiffusion, temperature gradients, and electric fields induced by charged species,
\begin{equation}
\overline{F} = -\rho\Wb\chib\left[\Gammab\nabla\xb + (\phib-\wb)\frac{\nabla P}{n k_B T} + \zetab\frac{\nabla T}{T} + \frac{\rho}{n k_B T}\left(\zb - (\wb^T\zb)\1b \right)\nabla\Phib\right].
\end{equation}
Here, $\Phib$ is the electric potential, given by the solution of the Poisson equation,
\begin{equation}
-\nabla\cdot\epsilon\nabla\Phib = \rho(\wb^T\zb),
\end{equation}
with $\rho(\wb^T\zb)$ the total charge density and $\epsilon$ the dielectric constant.
The point is that now the evaluation of $\Fb$
at a particular instance in time requires the solution of this Poisson equation.

\clearpage

\section{Inertial Algorithm}
Inertial algorithm description:\\ \\
{\bf Step 0: Initialization:}\\ \\
Begin with an initial guess for velocity, $\vb^{\rm init}$, and pressure, $p^0$.
Then, perform a projection to obtain an initial velocity field, $\vb^0$ that satisfies
\begin{equation}
\nabla\cdot\vb^0 = S^0 \equiv S(\Fb^0),
\end{equation}
where $\Fb_i^0$ and $\nabla\cdot\Fb_i^0$ are computed from $(\rho_i^0,T^0)$ using the 
supplied {\tt compute\_mass\_fluxdiv} subroutine.
For the projection, we solve for $\phi$ and update $\vb^{\rm init}$ as follows:
\begin{equation}
\nabla\cdot\frac{1}{\rho^0}\nabla\phi = \nabla\cdot\vb^{\rm init} - S^0,
\end{equation}
\begin{equation}
\vb^0 = \vb^{\rm init} - \frac{1}{\rho}\nabla\phi.
\end{equation}
{\bf Step 1: Calculate Predictor Diffusive and Stochastic Fluxes}\\ \\
Compute $\Fb_i^n$ and $\nabla\cdot\Fb_i^n$ from $(\rho_i^n,T^n)$ using the supplied 
{\tt compute\_mass\_fluxdiv} subroutine.  Construct $S^n$ using equation (\ref{eq:S}).
Note this step is functionally a null-op since we reuse the result from 
either {\bf Step 0} or {\bf Step 6} from the previous time step.\\ \\
{\bf Step 2: Predictor Euler Step}\\ \\
Using the velocity field from either {\bf Step 0} or {\bf Step 7} from the previous
time step, take a predictor forward Euler step for $\rho_i$:
\begin{equation}
\rho_i^{*,n+1} = \rho_i^n + \Delta t\nabla\cdot\left(-\rho_i^n\vb^n - \Fb^n\right).
\end{equation}
{\bf Step 3: Calculate Corrector Diffusive and Stochastic Fluxes}\\ \\
We reuse the same random numbers, but evaluate the diffusive fluxes and the noise amplitude from the predictor
to compute $\Fb^{*,n+1}$ and $S^{*,n+1}$.\\ \\
{\bf Step 4: Predictor Crank-Nicolson Step}\\ \\
Define $\vb^{*,n+1} = \overline\vb^n + \deltab\vb, p^{*,n+1} = p^n + \delta p$ (in these notes the overline
indicates the the velocity field has been modified to incorporate the boundary conditions on the
full velocity field after the solve) and solve
for $\deltab\vb$ and $\delta p$:
\begin{eqnarray}
\frac{\rho^{*,n+1}(\overline\vb^n + \deltab\vb) - \rho^n\vb^n}{\Delta t} + \nabla(p^n+\delta p) &=&\nonumber\\
&&\hspace{-1in}\nabla\cdot(-\rho^n\vb^n\vb^n) + \half\left[\mathcal{A}_0^n\vb^n + \mathcal{A}_0^{*,n+1}(\overline\vb^n + \deltab\vb)\right] + \nabla\cdot\underbrace{\sqrt{\frac{2\eta^n k_B T}{\Delta t\Delta V}}\overline\Wb^n}_{\Sigmab^n} + \rho^n\gb\nonumber\\
&&\hspace{-1in} - \half\left[\rho(\wb^T\zb)\nabla\Phib\right]^n - \half\left[\rho(\wb^T\zb)\nabla\Phib\right]^{*,n+1},
\end{eqnarray}
\begin{equation}
\nabla\cdot(\overline\vb^n+\deltab\vb) = S^{*,n+1}.
\end{equation}
We rewrite this system as
\begin{eqnarray}
\left(\frac{\rho^{*,n+1}}{\Delta t} - \half\mathcal{A}_0^{*,n+1}\right)\deltab\vb + \nabla\delta p &=& \frac{\rho^n\vb^n-\rho^{*,n+1}\overline\vb^n}{\Delta t} -\nabla p^n\nonumber\\
&&+ \nabla\cdot(-\rho^n\vb^n\vb^n) + \half\mathcal{A}_0^n\vb^n + \half\mathcal{A}_0^{*,n+1}\overline\vb^n + \nabla\cdot\Sigmab^n + \rho^n\gb\nonumber\\
&&- \half\left[\rho(\wb^T\zb)\nabla\Phib\right]^n - \half\left[\rho(\wb^T\zb)\nabla\Phib\right]^{*,n+1},\label{eq:CN Vel Pred}
\end{eqnarray}
\begin{equation}
-\nabla\cdot\deltab\vb = \nabla\cdot\overline\vb^n - S^{*,n+1}.
\end{equation}
Relating this to the GMRES solver, we can see that we are solving for 
$(\xb_\vb,x_p) = (\deltab\vb,\delta p)$ with $b_p = \nabla\cdot\overline\vb^n-S^{*,n+1}$ (note the change in sign!) 
and $\bb_\vb$ equal to the right-hand-side of (\ref{eq:CN Vel Pred}).  For the Helmholtz-like operator, 
$\mathcal{A}=\Theta\alpha\mathcal{I} - \mathcal{A}_0$, we have $\Theta=1/\Delta t, \alpha=\rho^{*,n+1}, 
\beta=\eta/2$, and $\gamma=\kappa/2$.
Next, define $\vb^{*,n+1} = \overline\vb^n + \deltab\vb$ and $p^{*,n+1} = p^n + \delta p$.\\ \\
{\bf Step 5: Trapezoidal Scalar Corrector}\\ \\
Update the densities:
\begin{equation}
\rho_i^{n+1} = \half\rho_i^n + \half\left[\rho_i^{*,n+1} + \Delta t\nabla\cdot(-\rho_i^{*,n+1}\vb^{*,n+1} - \Fb^{*,n+1})\right].
\end{equation}
{\bf Step 6: Calculate Diffusive and Stochastic Fluxes}\\ \\
Calculate the fluxes for the next time level using a new set of random numbers to obtain $\Fb^{n+1}$ and $S^{n+1}$.
{\bf Step 7: Corrector Crank-Nicolson Step}\\ \\
Take a corrector step for velocity, using the same random numbers as for the predictor
stage, but average the amplitude of the stochastic flux between time $n$ and $n+1$:
Define $\vb^{n+1} = \overline\vb^{*,n+1} + \deltab\vb$ and $p^{n+1} = p^{*,n+1} + \delta p$ and
solve the following system for $(\deltab\vb,\delta p)$:
\begin{eqnarray}
\frac{\rho^{n+1}(\overline\vb^{*,n+1} + \deltab\vb) - \rho^n\vb^n}{\Delta t} + \nabla(p^{*,n+1}+\delta p) &=& \half\nabla\cdot(-\rho^n\vb^n\vb^n - \rho^{*,n+1}\vb^{*,n+1}\vb^{*,n+1})\nonumber\\
&&\hspace{-1.5in}+ \half\left[\mathcal{A}_0^n\vb^n + \mathcal{A}_0^{n+1}(\overline\vb^{*,n+1} + \deltab\vb)\right]\nonumber\\
&&\hspace{-1.5in}+ \nabla\cdot\underbrace{\half\left(\sqrt{\frac{2\eta^n k_B T}{\Delta t\Delta V}} + \sqrt{\frac{2\eta^{n+1} k_B T}{\Delta t\Delta V}}\right)\overline\Wb^n}_{\Sigmab^{n'}} + \half\left(\rho^n+\rho^{n+1}\right)\gb\nonumber\\
&&\hspace{-1.5in} - \half\left[\rho(\wb^T\zb)\nabla\Phib\right]^n - \half\left[\rho(\wb^T\zb)\nabla\Phib\right]^{n+1},
\end{eqnarray}
\begin{equation}
\nabla\cdot(\overline\vb^{*,n+1} + \deltab\vb) = S^{n+1}.
\end{equation}
We rewrite this system as:
\begin{eqnarray}
\left(\frac{\rho^{n+1}}{\Delta t} - \half\mathcal{A}_0^{n+1}\right)\deltab\vb + \nabla\delta p &=& \frac{\rho^n\vb^n-\rho^{n+1}\overline\vb^{*,n+1}}{\Delta t} -\nabla p^n\nonumber\\
&&+ \half\nabla\cdot(-\rho^n\vb^n\vb^n - \rho^{*,n+1}\vb^{*,n+1}\vb^{*,n+1}) + \half(\mathcal{A}_0^n\vb^n + \mathcal{A}_0^{n+1}\overline\vb^{*,n+1} )\nonumber\\
&&+ \nabla\cdot\Sigmab^{n'} + \half\left(\rho^n+\rho^{n+1}\right)\gb\nonumber\\
&&- \half\left[\rho(\wb^T\zb)\nabla\Phib\right]^n - \half\left[\rho(\wb^T\zb)\nabla\Phib\right]^{n+1},
\end{eqnarray}
\begin{equation}
-\nabla\cdot\deltab\vb = \nabla\cdot\overline\vb^{*,n+1} - S^{n+1}.
\end{equation}

\bibliographystyle{plain}
\bibliography{DesignDocument}

\end{document}
