\documentclass[final]{siamltex}

% for red MarginPars
\usepackage{color}

% for \boldsymbol
\usepackage{amsmath}
\usepackage{latexsym}
\usepackage{graphicx}
\usepackage{geometry}
\usepackage{hyperref}

% total number of floats allowed on a page
\setcounter{totalnumber}{100}

% float page fractions
\renewcommand{\topfraction}{0.9}
\renewcommand{\bottomfraction}{0.9}
\renewcommand{\textfraction}{0.2}

% MarginPar
\setlength{\marginparwidth}{0.75in}
\newcommand{\MarginPar}[1]{\marginpar{\vskip-\baselineskip\raggedright\tiny\sffamily\hrule\smallskip{\color{red}#1}\par\smallskip\hrule}}

% for non-stacked fractions
\newcommand{\sfrac}[2]{\mathchoice
  {\kern0em\raise.5ex\hbox{\the\scriptfont0 #1}\kern-.15em/
   \kern-.15em\lower.25ex\hbox{\the\scriptfont0 #2}}
  {\kern0em\raise.5ex\hbox{\the\scriptfont0 #1}\kern-.15em/
   \kern-.15em\lower.25ex\hbox{\the\scriptfont0 #2}}
  {\kern0em\raise.5ex\hbox{\the\scriptscriptfont0 #1}\kern-.2em/
   \kern-.15em\lower.25ex\hbox{\the\scriptscriptfont0 #2}}
  {#1\!/#2}}

\def\1b {{\bf 1}}
\def\Ab {{\bf A}}
\def\bb {{\bf b}}
\def\Fb {{\bf F}}
\def\gb {{\bf g}}
\def\mb {{\bf m}}
\def\vb {{\bf v}}
\def\wb {{\bf w}}
\def\Wb {{\bf W}}
\def\xb {{\bf x}}
\def\zb {{\bf z}}

\def\chib   {\boldsymbol{\chi}}
\def\deltab {\boldsymbol{\delta}}
\def\Gammab {\boldsymbol{\Gamma}}
\def\phib   {\boldsymbol{\phi}}
\def\Phib   {\boldsymbol{\Phi}}
\def\Psib   {\boldsymbol{\Psi}}
\def\Sigmab {\boldsymbol{\Sigma}}
\def\taub   {\boldsymbol{\tau}}
\def\zetab  {\boldsymbol{\zeta}}

\def\half   {\frac{1}{2}}
\def\myhalf {\sfrac{1}{2}}

\begin{document}

%==========================================================================
% Title
%==========================================================================
\title{Low Mach Number Charged Species Notes}

\maketitle

\section{Introduction}
These are working notes for our low Mach number multicomponent charged fluid code.
The algorithm is an extension of our low Mach number multicomponent code
\cite{LowMachMulti}.  The algorithmic details are described more fully in
our previous works, in particular, the spatial discretization is described in
\cite{lowMachMixing}, and the temporal discretization for binary mixtures is
described in \cite{lowMachImplicit}.  The GMRES solver for the Stokes system
in our temporal advancement scheme is described in \cite{StokesPreconditioners}.

\section{Source Code}
There are two git repositories required to build/run the code.  BoxLib is a public
repository available on github using the command:\\ \\
{\tt git clone https://github.com/BoxLib-Codes/BoxLib.git}\\ \\
If you are not familiar with BoxLib, we recommend reading the BoxLib's User's Guide
in {\tt BoxLib/Docs}.\\

FluctHydro exists on CCSE servers and you need to contact Vince/Andy to get an account
and set up permissions on gamera.  Once you do, you can obtain the repository using:\\ \\
{\tt git clone <username>@gamera.lbl.gov:/usr/local/gitroot/FluctHydro.git}\\ \\
You will now have the following directory structures (you will actually have
more subdirectories, but below are the only directories that matter for this code):\\
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\begin{figure}[tb]
\centering
\includegraphics[width=6in]{./directory}
\caption{\label{fig:directory}Directory structure.}
\end{figure}
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\begin{itemize}

\item {\tt BoxLib/}

\begin{itemize}

\item {\tt Src/}

\begin{itemize}

\item {\tt F\_BaseLib/}

Core libraries for parallelization of structured grid data.

\item {\tt LinearSolvers/F\_MG/}

Core libraries for linear solvers (for implicit diffusion) and diffusion stencils.

\end{itemize}
\end{itemize}

\begin{itemize}

\item {\tt Tools/F\_mk/}

Make system variables and flags.

\end{itemize}
\end{itemize}

\begin{itemize}

\item {\tt FluctHydro/}

\begin{itemize}

\item {\tt HydroGrid/}

\item {\tt staggered\_grid/}

\begin{itemize}

\item {\tt exec/charged/doc/}

Contains the document you are reading right now!

\item {\tt exec/charged/test/}

This is the compilation directory.  Contains a GNUmakefile and inputs files.

\item {\tt src\_common/}

Source code shared by all our staggered grid codes.  Contains generic namelist parameters
and routines for boundary conditions, divergence, etc.

\item {\tt src\_multiSpec/}

Source code shared by all multicomponent codes.

\item {\tt src\_gmres/}

Source code for our GMRES stokes solver.

\item {\tt src\_charged/}

Source code specific to this charged fluid problem.

\end{itemize}
\end{itemize}
\end{itemize}

\subsection{Compiling and Running}
Go to {\tt FluctHydro/staggered\_grid/exec/charged/test/} and edit the 
{\tt GNUmakefile} settings to your liking (below) and simply type {\tt `make'}.\\
\begin{verbatim}
NDEBUG    :=           # 'not debug'.  use 't' for an optimized build
MPI       := t         # use 't' to build an mpi executable
OMP       :=           # use 't' to build an OpenMP threadded executable
PROF      :=           # use 't' to turn on code profiling
COMP      := gfortran  # fortran compiler
CCOMP     := gcc       # c compiler
MKVERBOSE := t         # make verbosity

\end{verbatim}
This will generate an executable whose name provides information about the build settings,
i.e., what compiler was used, whether MPI and/or OpenMP were enabled, etc.
To run the code, simply type the executable name, followed by an inputs file.

\subsection{Input Parameters}
Refer to
\begin{itemize}
\item {\tt src\_common/probin\_common.f90}, 
\item {\tt src\_multiSpec/probin\_multiSpec.f90}, 
\item {\tt src\_gmres/probin\_gmres.f90}
\item {\tt src\_charged/probin\_charged.f90}
\end{itemize}
for namelist parameters used in the simulation and an explanation of what the parameters do.

\section{Equations}
The equations for the momentum and densities are:
\begin{eqnarray}
\frac{\partial\rho\vb}{\partial t} &=& - \nabla\cdot(\rho\vb\vb) - \nabla\pi + \nabla\cdot\taub + \rho\gb - \rho(\wb^T\zb)\nabla\Phi\\
\frac{\partial\rho_i}{\partial t} &=& -\nabla\cdot(\rho_i\vb) - \nabla\cdot\Fb_i,
\end{eqnarray}
with $\rho$ the total density, $\rho_i$ the density of component $i$, $\vb$ the fluid 
velocity, $\pi$ the perturbational pressure, $\taub$ the stress tensor, $\gb$ the
gravitational acceleration, $\wb = (w_1, w_2, \cdots)$ the vector of concentrations
(mass fractions), $\zb$ the charge per unit mass, $\Phi$ the electric potential,
and $\Fb_i$ the mass fluxes for component $i$.
Note the total charge density is $\rho(\wb^T\zb)$.

The mass fluxes include contributions from compositional gradients, barodiffusion,
thermodiffusion, electrostatic, and stochastic driving forces as described below.
The deterministic part of the mass fluxes, $\overline{\Fb}$, contains contributions from 
compositional gradients, barodiffusion, themodiffusion, and electrostatic driving forces,
\begin{equation}
\overline{\Fb} = -\rho\Wb\chib\left[\Gammab\nabla\xb + (\phib-\wb)\frac{\nabla P}{n k_B T} + \zetab\frac{\nabla T}{T} + \frac{\rho}{n k_B T}\Wb\left(\zb - (\wb^T\zb)\1b \right)\nabla\Phib\right].
\end{equation}
Note $n = \sum_i(\rho_i/w_i)$ is the number density, and 
$\rho/n = \overline{m} = (\sum_i w_i/m_i)^{-1}$ is the 
mixture-average molecular mass.

The electric potential can by found by solving the Poisson equation,
\begin{equation}
-\nabla\cdot\epsilon\nabla\Phib = \rho(\wb^T\zb),
\end{equation}
with $\epsilon$ the dielectric constant.  Now the evaluation of $\Fb$
at a particular instance in time requires the solution of this Poisson equation.

The equation of state can be found by assuming no volume changing upon mixing,
and differentiating along particle paths (as in our previous low Mach mixing
papaer; will add more details):
\begin{equation}
\nabla\cdot\vb = -\nabla\cdot\left(\sum_i\frac{\Fb_i}{\bar\rho_i}\right) \equiv S\label{eq:S}.
\end{equation}

\subsection{Linearized Analysis}

\clearpage

\section{Inertial Algorithm}
Inertial algorithm description:\\ \\
{\bf Step 0: Initialization:}\\ \\
Begin with an initial guess for velocity, $\vb^{\rm init}$, and pressure, $p^0$.
Then, perform a projection to obtain an initial velocity field, $\vb^0$ that satisfies
\begin{equation}
\nabla\cdot\vb^0 = S^0 \equiv S(\Fb^0),
\end{equation}
where $\Fb_i^0$ and $\nabla\cdot\Fb_i^0$ are computed from $(\rho_i^0,T^0)$ using the 
supplied {\tt compute\_mass\_fluxdiv} subroutine.
For the projection, we solve for $\phi$ and update $\vb^{\rm init}$ as follows:
\begin{equation}
\nabla\cdot\frac{1}{\rho^0}\nabla\phi = \nabla\cdot\vb^{\rm init} - S^0,
\end{equation}
\begin{equation}
\vb^0 = \vb^{\rm init} - \frac{1}{\rho}\nabla\phi.
\end{equation}
{\bf Step 1: Calculate Predictor Diffusive and Stochastic Fluxes}\\ \\
Compute $\Fb_i^n$ and $\nabla\cdot\Fb_i^n$ from $(\rho_i^n,T^n)$ using the supplied 
{\tt compute\_mass\_fluxdiv} subroutine.  Construct $S^n$ using equation (\ref{eq:S}).
Note this step is functionally a null-op since we reuse the result from 
either {\bf Step 0} or {\bf Step 6} from the previous time step.\\ \\
{\bf Step 2: Predictor Euler Step}\\ \\
Using the velocity field from either {\bf Step 0} or {\bf Step 7} from the previous
time step, take a predictor forward Euler step for $\rho_i$:
\begin{equation}
\rho_i^{*,n+1} = \rho_i^n + \Delta t\nabla\cdot\left(-\rho_i^n\vb^n - \Fb^n\right).
\end{equation}
{\bf Step 3: Calculate Corrector Diffusive and Stochastic Fluxes}\\ \\
We reuse the same random numbers, but evaluate the diffusive fluxes and the noise amplitude from the predictor
to compute $\Fb^{*,n+1}$ and $S^{*,n+1}$.\\ \\
{\bf Step 4: Predictor Crank-Nicolson Step}\\ \\
Define $\vb^{*,n+1} = \overline\vb^n + \deltab\vb, p^{*,n+1} = p^n + \delta p$ (in these notes the overline
indicates the the velocity field has been modified to incorporate the boundary conditions on the
full velocity field after the solve) and solve
for $\deltab\vb$ and $\delta p$:
\begin{eqnarray}
\frac{\rho^{*,n+1}(\overline\vb^n + \deltab\vb) - \rho^n\vb^n}{\Delta t} + \nabla(p^n+\delta p) &=&\nonumber\\
&&\hspace{-1in}\nabla\cdot(-\rho^n\vb^n\vb^n) + \half\left[\mathcal{A}_0^n\vb^n + \mathcal{A}_0^{*,n+1}(\overline\vb^n + \deltab\vb)\right] + \nabla\cdot\underbrace{\sqrt{\frac{2\eta^n k_B T}{\Delta t\Delta V}}\overline\Wb^n}_{\Sigmab^n} + \rho^n\gb\nonumber\\
&&\hspace{-1in} - \half\left[\rho(\wb^T\zb)\nabla\Phib\right]^n - \half\left[\rho(\wb^T\zb)\nabla\Phib\right]^{*,n+1},
\end{eqnarray}
\begin{equation}
\nabla\cdot(\overline\vb^n+\deltab\vb) = S^{*,n+1}.
\end{equation}
We rewrite this system as
\begin{eqnarray}
\left(\frac{\rho^{*,n+1}}{\Delta t} - \half\mathcal{A}_0^{*,n+1}\right)\deltab\vb + \nabla\delta p &=& \frac{\rho^n\vb^n-\rho^{*,n+1}\overline\vb^n}{\Delta t} -\nabla p^n\nonumber\\
&&+ \nabla\cdot(-\rho^n\vb^n\vb^n) + \half\mathcal{A}_0^n\vb^n + \half\mathcal{A}_0^{*,n+1}\overline\vb^n + \nabla\cdot\Sigmab^n + \rho^n\gb\nonumber\\
&&- \half\left[\rho(\wb^T\zb)\nabla\Phib\right]^n - \half\left[\rho(\wb^T\zb)\nabla\Phib\right]^{*,n+1},\label{eq:CN Vel Pred}
\end{eqnarray}
\begin{equation}
-\nabla\cdot\deltab\vb = \nabla\cdot\overline\vb^n - S^{*,n+1}.
\end{equation}
Relating this to the GMRES solver, we can see that we are solving for 
$(\xb_\vb,x_p) = (\deltab\vb,\delta p)$ with $b_p = \nabla\cdot\overline\vb^n-S^{*,n+1}$ (note the change in sign!) 
and $\bb_\vb$ equal to the right-hand-side of (\ref{eq:CN Vel Pred}).  For the Helmholtz-like operator, 
$\mathcal{A}=\Theta\alpha\mathcal{I} - \mathcal{A}_0$, we have $\Theta=1/\Delta t, \alpha=\rho^{*,n+1}, 
\beta=\eta/2$, and $\gamma=\kappa/2$.
Next, define $\vb^{*,n+1} = \overline\vb^n + \deltab\vb$ and $p^{*,n+1} = p^n + \delta p$.\\ \\
{\bf Step 5: Trapezoidal Scalar Corrector}\\ \\
Update the densities:
\begin{eqnarray}
\rho_i^{n+1} &=&
\rho_i^n + \frac{\Delta t}{2}\nabla\cdot\left(-\rho_i^n\vb^n - \Fb^n\right) + \frac{\Delta t}{2}\nabla\cdot\left(-\rho_i^{*,n+1}\vb^{*,n+1} - \Fb^{*,n+1}\right)\nonumber\\
&=&  \half\rho_i^n + \half\left[\rho_i^{*,n+1} + \Delta t\nabla\cdot(-\rho_i^{*,n+1}\vb^{*,n+1} - \Fb^{*,n+1})\right].
\end{eqnarray}
{\bf Step 6: Calculate Diffusive and Stochastic Fluxes}\\ \\
Calculate the fluxes for the next time level using a new set of random numbers to obtain $\Fb^{n+1}$ and $S^{n+1}$.\\ \\
{\bf Step 7: Corrector Crank-Nicolson Step}\\ \\
Take a corrector step for velocity, using the same random numbers as for the predictor
stage, but average the amplitude of the stochastic flux between time $n$ and $n+1$:
Define $\vb^{n+1} = \overline\vb^{*,n+1} + \deltab\vb$ and $p^{n+1} = p^{*,n+1} + \delta p$ and
solve the following system for $(\deltab\vb,\delta p)$:
\begin{eqnarray}
\frac{\rho^{n+1}(\overline\vb^{*,n+1} + \deltab\vb) - \rho^n\vb^n}{\Delta t} + \nabla(p^{*,n+1}+\delta p) &=& \half\nabla\cdot(-\rho^n\vb^n\vb^n - \rho^{*,n+1}\vb^{*,n+1}\vb^{*,n+1})\nonumber\\
&&\hspace{-1.5in}+ \half\left[\mathcal{A}_0^n\vb^n + \mathcal{A}_0^{n+1}(\overline\vb^{*,n+1} + \deltab\vb)\right]\nonumber\\
&&\hspace{-1.5in}+ \nabla\cdot\underbrace{\half\left(\sqrt{\frac{2\eta^n k_B T}{\Delta t\Delta V}} + \sqrt{\frac{2\eta^{n+1} k_B T}{\Delta t\Delta V}}\right)\overline\Wb^n}_{\Sigmab^{n'}} + \half\left(\rho^n+\rho^{n+1}\right)\gb\nonumber\\
&&\hspace{-1.5in} - \half\left[\rho(\wb^T\zb)\nabla\Phib\right]^n - \half\left[\rho(\wb^T\zb)\nabla\Phib\right]^{n+1},
\end{eqnarray}
\begin{equation}
\nabla\cdot(\overline\vb^{*,n+1} + \deltab\vb) = S^{n+1}.
\end{equation}
We rewrite this system as:
\begin{eqnarray}
\left(\frac{\rho^{n+1}}{\Delta t} - \half\mathcal{A}_0^{n+1}\right)\deltab\vb + \nabla\delta p &=& \frac{\rho^n\vb^n-\rho^{n+1}\overline\vb^{*,n+1}}{\Delta t} -\nabla p^n\nonumber\\
&&+ \half\nabla\cdot(-\rho^n\vb^n\vb^n - \rho^{*,n+1}\vb^{*,n+1}\vb^{*,n+1}) + \half(\mathcal{A}_0^n\vb^n + \mathcal{A}_0^{n+1}\overline\vb^{*,n+1} )\nonumber\\
&&+ \nabla\cdot\Sigmab^{n'} + \half\left(\rho^n+\rho^{n+1}\right)\gb\nonumber\\
&&- \half\left[\rho(\wb^T\zb)\nabla\Phib\right]^n - \half\left[\rho(\wb^T\zb)\nabla\Phib\right]^{n+1},
\end{eqnarray}
\begin{equation}
-\nabla\cdot\deltab\vb = \nabla\cdot\overline\vb^{*,n+1} - S^{n+1}.
\end{equation}

\section{Implicit Potential Algorithm}
Ignoring barodiffusion and thermodiffusion we have
\begin{equation}
\overline{\Fb} = -\rho\Wb\chib\left[\Gammab\nabla\xb + \frac{\rho}{n k_B T}\Wb\left(\zb - (\wb^T\zb)\1b \right)\nabla\Phib\right],
\end{equation}
\begin{equation}
-\nabla\cdot\epsilon\nabla\Phib = \rho(\wb^T\zb),
\end{equation}
where the total charge vector, $(\wb^T\zb){\bf 1}$, is in the null space of $\chib$.
Thus, we can simplify the mass fluxes,
\begin{eqnarray}
\overline{\Fb} &=& -\rho\Wb\chib\left[\Gammab\nabla\xb + \frac{\rho}{n k_B T}\Wb\zb\nabla\Phib\right]\nonumber\\
&=& -\rho\Wb\chib\Gammab\nabla\xb - \underbrace{\frac{\rho^2}{nk_B T}\Wb\chib\Wb\zb}_{\Ab_\Phi}\nabla\Phib
\end{eqnarray}
where $\Ab_\Phi$ is the electrostatic mass flux coefficient.
The term proportional to the electric field, $\nabla\Phib$, is potentially stiff.  We 
use the parameter $\theta$ to generalize the electric potential temporal discretization
to explicit, semi-implicit, implicit, etc.  We will try the implicit case ($\theta=1$).\\ \\
{\bf Step 1: Predictor Density Update}\\ \\
Perform a forward Euler density update,
\begin{equation}
\rho^{*,n+1} = \rho^n + \Delta t \nabla\cdot(-\rho\vb)^n.
\end{equation}
{\bf Step 2: Predictor Concentration Update}\\ \\
We would like to solve the following,
\begin{equation}
\frac{(\rho\wb)^{*,n+1} - (\rho\wb)^n}{\Delta t} + \nabla\cdot(\rho\wb\vb)^n =
\nabla\cdot(\rho\Wb\chib\Gammab\nabla\xb)^n + \theta\nabla\cdot \Ab_\Phi^n\nabla\Phib^{*,n+1} +
(1-\theta)\nabla\cdot \Ab_\Phi^n\nabla\Phib^n,\label{eq:implicit phi}
\end{equation}
\begin{equation}
-\nabla\cdot\epsilon\nabla\Phib^{*,n+1} = \left[\rho(\wb^T\zb)\right]^{*,n+1},\label{eq:constraint}
\end{equation}
but we can't directly.  Rewriting equation (\ref{eq:implicit phi}) gives,
\begin{eqnarray}
(\rho\wb)^{*,n+1} - \Delta t\theta\nabla\cdot \Ab_\Phi^n\nabla\Phib^{*,n+1} &=& \nonumber\\
&&\hspace{-1.5in}(\rho\wb)^n + \Delta t\underbrace{\left[-\nabla\cdot(\rho\wb\vb)^n + \nabla\cdot(\rho\Wb\chib\Gammab\nabla\xb)^n + (1-\theta) \nabla\cdot \Ab_\Phi^n\nabla\Phib^n\right]}_{\mathcal{R}_p}\label{eq:implicit phi2}
\end{eqnarray}
Applying $\zb^T$ to equation (\ref{eq:implicit phi2}) gives
\begin{equation}
\zb^T(\rho\wb^{*,n+1}) - \Delta t\theta\zb^T\nabla\cdot \Ab_\Phi^n\nabla\Phib^{*,n+1} = \zb^T\left((\rho\wb)^n + \Delta t\mathcal{R}_p\right)
\end{equation}
Substituting this into equation (\ref{eq:constraint}) gives
\begin{equation}
-\nabla\cdot\left(\epsilon + \Delta t\theta\zb^T \Ab_\Phi^n\right)\nabla\Phib^{*,n+1} = \zb^T\left((\rho\wb)^n + \Delta t\mathcal{R}_p\right),
\end{equation}
which we solve for $\Phib^{*,n+1}$.  Note that
\begin{equation}
\zb^T \Ab_\Phi = \frac{\rho^2}{nk_BT}\zb^T\Wb\chib\Wb\zb,
\end{equation}
and since $\Wb\chib\Wb$ is positive semi-definite, then $\zb^T\Wb\chib\Wb\zb \ge 0$,
the coefficients in the Poisson solve all have the same sign, and thus the system
is elliptic.  Once we have $\Phib^{*,n+1}$, we can compute $\wb^{*,n+1}$ using
(\ref{eq:implicit phi}).\\ \\
{\bf Step 3: Predictor Crank-Nicolson Step}\\ \\
Define $\vb^{*,n+1} = \overline\vb^n + \deltab\vb, p^{*,n+1} = p^n + \delta p$ (in these notes the overline
indicates the the velocity field has been modified to incorporate the boundary conditions on the
full velocity field after the solve) and solve
for $\deltab\vb$ and $\delta p$:
\begin{eqnarray}
\frac{\rho^{*,n+1}(\overline\vb^n + \deltab\vb) - \rho^n\vb^n}{\Delta t} + \nabla(p^n+\delta p) &=&\nonumber\\
&&\hspace{-1in}\nabla\cdot(-\rho^n\vb^n\vb^n) + \half\left[\mathcal{A}_0^n\vb^n + \mathcal{A}_0^{*,n+1}(\overline\vb^n + \deltab\vb)\right] + \nabla\cdot\underbrace{\sqrt{\frac{2\eta^n k_B T}{\Delta t\Delta V}}\overline\Wb^n}_{\Sigmab^n} + \rho^n\gb\nonumber\\
&&\hspace{-1in}- (1-\theta)\left[\rho(\wb^T\zb)\nabla\Phib\right]^n - \theta\left[\rho(\wb^T\zb)\nabla\Phib\right]^{*,n+1},
\end{eqnarray}
\begin{equation}
\nabla\cdot(\overline\vb^n+\deltab\vb) = \underbrace{S[-(\rho\Wb\chib\Gammab\nabla\xb)^{*,n+1} - \Ab_\Phi^n\nabla\Phib^{*,n+1}]}_{S_p}.
\end{equation}
We rewrite this system as
\begin{eqnarray}
\left(\frac{\rho^{*,n+1}}{\Delta t} - \half\mathcal{A}_0^{*,n+1}\right)\deltab\vb + \nabla\delta p &=& \frac{\rho^n\vb^n-\rho^{*,n+1}\overline\vb^n}{\Delta t} -\nabla p^n\nonumber\\
&&+ \nabla\cdot(-\rho^n\vb^n\vb^n) + \half\mathcal{A}_0^n\vb^n + \half\mathcal{A}_0^{*,n+1}\overline\vb^n + \nabla\cdot\Sigmab^n + \rho^n\gb\nonumber\\
&&- (1-\theta)\left[\rho(\wb^T\zb)\nabla\Phib\right]^n - \theta\left[\rho(\wb^T\zb)\nabla\Phib\right]^{*,n+1},\label{eq:CN Vel Pred2}
\end{eqnarray}
\begin{equation}
-\nabla\cdot\deltab\vb = \nabla\cdot\overline\vb^n - S_p
\end{equation}
Relating this to the GMRES solver, we can see that we are solving for 
$(\xb_\vb,x_p) = (\deltab\vb,\delta p)$ with $b_p = \nabla\cdot\overline\vb^n-S_p$ (note the change in sign!) 
and $\bb_\vb$ equal to the right-hand-side of (\ref{eq:CN Vel Pred2}).  For the Helmholtz-like operator, 
$\mathcal{A}=\Theta\alpha\mathcal{I} - \mathcal{A}_0$, we have $\Theta=1/\Delta t, \alpha=\rho^{*,n+1}, 
\beta=\eta/2$, and $\gamma=\kappa/2$.
Next, define $\vb^{*,n+1} = \overline\vb^n + \deltab\vb$ and $p^{*,n+1} = p^n + \delta p$.\\ \\
{\bf Step 4: Corrector Density Update}
Perform a trapezoidal density update,
\begin{equation}
\rho^{n+1} = \rho^n + \frac{\Delta t}{2} \nabla\cdot(-\rho\vb)^n + \frac{\Delta t}{2} \nabla\cdot(-\rho\vb)^{*,n+1}.
\end{equation}
{\bf Step 5: Corrector Concentration Update}\\ \\
We would like to solve the following,
\begin{eqnarray}
\frac{(\rho\wb)^{n+1} - (\rho\wb^n)}{\Delta t} + \half\nabla\cdot(\rho\wb\vb)^n + \half\nabla\cdot(\rho\wb\vb)^{*,n+1} &=&\half\nabla\cdot(\rho\Wb\chib\Gammab\nabla\xb)^n + \half\nabla\cdot(\rho\Wb\chib\Gammab\nabla\xb)^{*,n+1} \nonumber\\
&&\hspace{-2in} + \theta\nabla\cdot \Ab_\Phi^{*,n+1}\nabla\Phib^{n+1} +
(1-\theta)\nabla\cdot \Ab_\Phi^n\nabla\Phib^n,\label{eq:implicit phi3}
\end{eqnarray}
\begin{equation}
-\nabla\cdot\epsilon\nabla\Phib^{n+1} = \left[\rho(\wb^T\zb)\right]^{n+1},\label{eq:constraint2}
\end{equation}
but we can't directly.  Rewriting equation (\ref{eq:implicit phi3} gives,
\begin{eqnarray}
(\rho\wb^{n+1}) - \Delta t\theta\nabla\cdot \Ab_\Phi^{*,n+1}\nabla\Phib^{n+1} &=& (\rho\wb)^n\nonumber\\
&&\hspace{-2.5in}+ \Delta t\underbrace{\left[-\half\nabla\cdot(\rho\wb\vb)^n - \half\nabla\cdot(\rho\wb\vb)^{*,n+1} + \half\nabla\cdot(\rho\Wb\chib\Gammab\nabla\xb)^n + \half\nabla\cdot(\rho\Wb\chib\Gammab\nabla\xb)^{*,n+1}+ (1-\theta)\nabla\cdot \Ab_\Phi^n\nabla\Phib^{n+1} \right]}_{\mathcal{R}_c}\label{eq:implicit phi4}\nonumber\\
\end{eqnarray}
Applying $\zb^T$ to equation (\ref{eq:implicit phi4}) gives
\begin{equation}
\zb^T(\rho\wb)^{n+1} - \Delta t\theta\zb^T\nabla\cdot \Ab_\Phi^{*,n+1}\nabla\Phib^{n+1} = \zb^T((\rho\wb)^n + \Delta t\mathcal{R}_c).
\end{equation}
Substituting this into equation (\ref{eq:constraint2}) gives
\begin{equation}
-\nabla\cdot\left(\epsilon + \Delta t\theta\zb^T \Ab_\Phi^{*,n+1}\right)\nabla\Phib^{n+1} = \zb^T\left((\rho\wb)^n + \Delta t\mathcal{R}_c\right),
\end{equation}
which we solve for $\Phib^{n+1}$.  Once we have $\Phib^{n+1}$, we can compute 
$(\rho\wb)^{n+1}$ using (\ref{eq:implicit phi3}).\\ \\
{\bf Step 6: Corrector Crank-Nicolson Step}\\ \\
Take a corrector step for velocity, using the same random numbers as for the predictor
stage, but average the amplitude of the stochastic flux between time $n$ and $n+1$:
Define $\vb^{n+1} = \overline\vb^{*,n+1} + \deltab\vb$ and $p^{n+1} = p^{*,n+1} + \delta p$ and
solve the following system for $(\deltab\vb,\delta p)$:
\begin{eqnarray}
\frac{\rho^{n+1}(\overline\vb^{*,n+1} + \deltab\vb) - \rho^n\vb^n}{\Delta t} + \nabla(p^{*,n+1}+\delta p) &=& \half\nabla\cdot(-\rho^n\vb^n\vb^n - \rho^{*,n+1}\vb^{*,n+1}\vb^{*,n+1})\nonumber\\
&&\hspace{-1.5in}+ \half\left[\mathcal{A}_0^n\vb^n + \mathcal{A}_0^{n+1}(\overline\vb^{*,n+1} + \deltab\vb)\right]\nonumber\\
&&\hspace{-1.5in}+ \nabla\cdot\underbrace{\half\left(\sqrt{\frac{2\eta^n k_B T}{\Delta t\Delta V}} + \sqrt{\frac{2\eta^{n+1} k_B T}{\Delta t\Delta V}}\right)\overline\Wb^n}_{\Sigmab^{n'}} + \half\left(\rho^n+\rho^{n+1}\right)\gb\nonumber\\
&&\hspace{-1.5in} - (1-\theta)\left[\rho(\wb^T\zb)\nabla\Phib\right]^n - \theta\left[\rho(\wb^T\zb)\nabla\Phib\right]^{n+1},
\end{eqnarray}
\begin{equation}
\nabla\cdot(\overline\vb^{*,n+1} + \deltab\vb) =  \underbrace{S[-(\rho\Wb\chib\Gammab\nabla\xb)^{n+1} - \Ab_\Phi^{*,n+1}\nabla\Phib^{n+1}]}_{S_c}.
\end{equation}
We rewrite this system as:
\begin{eqnarray}
\left(\frac{\rho^{n+1}}{\Delta t} - \half\mathcal{A}_0^{n+1}\right)\deltab\vb + \nabla\delta p &=& \frac{\rho^n\vb^n-\rho^{n+1}\overline\vb^{*,n+1}}{\Delta t} -\nabla p^n\nonumber\\
&&+ \half\nabla\cdot(-\rho^n\vb^n\vb^n - \rho^{*,n+1}\vb^{*,n+1}\vb^{*,n+1}) + \half(\mathcal{A}_0^n\vb^n + \mathcal{A}_0^{n+1}\overline\vb^{*,n+1} )\nonumber\\
&&+ \nabla\cdot\Sigmab^{n'} + \half\left(\rho^n+\rho^{n+1}\right)\gb\nonumber\\
&&- (1-\theta)\left[\rho(\wb^T\zb)\nabla\Phib\right]^n - \theta\left[\rho(\wb^T\zb)\nabla\Phib\right]^{n+1},
\end{eqnarray}
\begin{equation}
-\nabla\cdot\deltab\vb = \nabla\cdot\overline\vb^{*,n+1} - S_c.
\end{equation}
\bibliographystyle{plain}
\bibliography{DesignDocument}

\end{document}
