\documentclass[final]{siamltex}

% for red MarginPars
\usepackage{color}

% for \boldsymbol
\usepackage{amsmath}
\usepackage{latexsym}
\usepackage{graphicx}
\usepackage{geometry}
\usepackage{hyperref}

% total number of floats allowed on a page
\setcounter{totalnumber}{100}

% float page fractions
\renewcommand{\topfraction}{0.9}
\renewcommand{\bottomfraction}{0.9}
\renewcommand{\textfraction}{0.2}

% MarginPar
\setlength{\marginparwidth}{0.75in}
\newcommand{\MarginPar}[1]{\marginpar{\vskip-\baselineskip\raggedright\tiny\sffamily\hrule\smallskip{\color{red}#1}\par\smallskip\hrule}}

% for non-stacked fractions
\newcommand{\sfrac}[2]{\mathchoice
  {\kern0em\raise.5ex\hbox{\the\scriptfont0 #1}\kern-.15em/
   \kern-.15em\lower.25ex\hbox{\the\scriptfont0 #2}}
  {\kern0em\raise.5ex\hbox{\the\scriptfont0 #1}\kern-.15em/
   \kern-.15em\lower.25ex\hbox{\the\scriptfont0 #2}}
  {\kern0em\raise.5ex\hbox{\the\scriptscriptfont0 #1}\kern-.2em/
   \kern-.15em\lower.25ex\hbox{\the\scriptscriptfont0 #2}}
  {#1\!/#2}}

\def\bb {{\bf b}}
\def\Fb {{\bf F}}
\def\gb {{\bf g}}
\def\vb {{\bf v}}
\def\Wb {{\bf W}}
\def\xb {{\bf x}}

\def\deltab {\boldsymbol{\delta}}
\def\Psib   {\boldsymbol{\Psi}}
\def\Sigmab {\boldsymbol{\Sigma}}

\def\half   {\frac{1}{2}}
\def\myhalf {\sfrac{1}{2}}

\begin{document}

%==========================================================================
% Title
%==========================================================================
\title{Implicit Low Mach Number Multispecies Mixing Notes}

\maketitle

\section{Equations}
Overdetermined equations for the densities:
\begin{eqnarray}
\frac{\partial\rho}{\partial t} &=& -\nabla\cdot(\rho\vb)\\
\frac{\partial\rho_i}{\partial t} &=& -\nabla\cdot(\rho_i\vb) + \nabla\cdot\Fb_i,
\end{eqnarray}
with $\Fb_i$ containing both the diffusive and stochastic mass fluxes.  The equation of state is:
\begin{equation}
\nabla\cdot\vb = \nabla\cdot\left(\sum_i\frac{\Fb_i}{\bar\rho_i}\right) \equiv S\label{eq:S}.
\end{equation}

\clearpage

\section{Overdamped 1RNG Algorithm}
This algorithm is of limited use since it is not formally second-order accurate.  It was
an early test algorithm, and it so happens that the second Stokes solve is a null-op
for the constant-coefficient, incompressible, no gravity case.  But anyway, here it
is for the record.\\ \\
{\bf Step 0: Initialization:}\\ \\
Begin with an initial guess for velocity, $\vb^{-\myhalf}$ (note this only used as a reference state for the GMRES
solve and for computing the right-hand-side for pressure, so it does not have to satisfy any constraint),
and pressure, $p^{-\myhalf}$.\\ \\
{\bf Step 1: Predictor Stochastic/Diffusive Fluxes:}\\ \\
Compute $\Fb_i^n$ and $\nabla\cdot\Fb_i^n$ from $(\rho_i^n,T^n)$
using the supplied {\tt compute\_mass\_fluxdiv} subroutine.
Pass in $\Delta t$ as the scaling factor for the random fluxes.
Construct $S^n$ using equation (\ref{eq:S}).\\ \\
{\bf Step 2: Predictor Stokes Solve:}
Generate a random advection velocity by solving the steady Stokes equation with random forcing.
Define $p^* = p^{n-\myhalf} + \delta p$ and $\vb^* = \overline\vb^{n-\myhalf} + \delta\vb$ 
(in these notes the overline indicates the the velocity field has been modified to incorporate
the boundary conditions on the full velocity field after the solve) and solve:
\begin{equation}
\nabla(p^{n-\myhalf} + \delta p) = \mathcal A_0^n(\overline\vb^{n-\myhalf} + \deltab\vb) + \nabla\cdot\underbrace{\sqrt{\frac{2\eta^n k_B T}{\Delta t\Delta V}}\overline\Wb^n}_{\Sigmab^{(1)}} + \rho^n\gb,
\end{equation}
\begin{equation}
\nabla\cdot(\overline\vb^{n-\myhalf} + \delta\vb) = S^n,
\end{equation}
which can be written as
\begin{equation}
-\mathcal{A}_0^n\deltab\vb + \nabla\delta p = -\nabla p^{n-\myhalf} + \mathcal{A}_0^n\overline\vb^{n-\myhalf}
+ \nabla\cdot\Sigmab^{(1)}  + \rho^n\gb,
\end{equation}
\begin{equation}
-\nabla\cdot\deltab\vb = \nabla\cdot\overline\vb^{n-\myhalf} - S^n.
\end{equation}
{\bf Step 3: Scalar Predictor Midpoint Euler Step}\\ \\
Take a midpoint predictor forward Euler step for $\rho_i$:
\begin{equation}
\rho_i^{*,n+\myhalf} = \rho_i^n + \frac{\Delta t}{2}\nabla\cdot(-\rho_i^n\vb^* + \Fb_i^n).
\end{equation}
Set $\rho^{*,n+\myhalf} = \sum_i\rho_i^{*,n+\myhalf}$.\\ \\
{\bf Step 4: Corrector Stochastic/Diffusive Fluxes:}\\ \\
Compute $\Fb_i^{*,n+\myhalf}$ and 
$\nabla\cdot\Fb_i^{*,n+\myhalf}$ from $(\rho_i^{*,n+\myhalf},T^{*,n+\myhalf})$ using the supplied 
{\tt compute\_mass\_fluxdiv} subroutine.
Pass in $\Delta t/2$ as the scaling factor for the random fluxes.
Construct $S^{*,n+\myhalf}$ using equation (\ref{eq:S}).\\ \\
{\bf Step 5: Corrector Stokes Solve:}\\ \\
Solve a steady Stokes system with $p^{n+\myhalf} = p^* + \delta p$ and $\vb^{n+\myhalf} = \overline\vb^* + \delta\vb$:
\begin{equation}
\nabla(p^* + \delta p) = \mathcal A_0^{*,n+\myhalf}(\overline\vb^* + \deltab\vb) + \nabla\cdot\underbrace{\sqrt{\frac{2\eta^{*,n+\myhalf} k_B T}{\Delta t\Delta V}}\overline\Wb^n}_{\Sigmab^{(2)}} + \rho^{*,n+\myhalf}\gb,
\end{equation}
\begin{equation}
\nabla\cdot(\overline\vb^* + \delta\vb) = S^{*,n+\myhalf},
\end{equation}
which can be written as
\begin{equation}
-\mathcal{A}_0^{*,n+\myhalf}\deltab\vb + \nabla\delta p = -\nabla p^* + \mathcal{A}_0^{*,n+\myhalf}\overline\vb^*
+ \nabla\cdot\Sigmab^{(2)} + \rho^{*,n+\myhalf}\gb,
\end{equation}
\begin{equation}
-\nabla\cdot\deltab\vb = \nabla\cdot\overline\vb^* - S^{*,n+\myhalf}.
\end{equation}
Next, define $\vb^{n+\myhalf} = \overline\vb^* + \deltab\vb$ and $p^{n+\myhalf} = p^* + \delta p$.\\ \\
{\bf Step 6: Midpoint Scalar Corrector:}\\ \\
Update the densities and concentrations
\begin{eqnarray}
\rho_i^{n+1} &=& \rho_i^n + \Delta t\left(-\rho_i^{*,n+\myhalf}\vb^{n+\myhalf} + \Fb_i^{*,n+\myhalf}\right).
\end{eqnarray}
Set $\rho^{n+1} = \sum_i\rho_i^{n+1}$.

\clearpage

\section{Overdamped 2RNG Algorithm}
This is our preferred algorithm.\\ \\
{\bf Step 0: Initialization:}\\ \\
Begin with an initial guess for velocity, $\vb^{-\myhalf}$ (note this only used as a reference state for the GMRES
solve and for computing the right-hand-side for pressure, so it does not have to satisfy any constraint),
and pressure, $p^{-\myhalf}$.\\ \\
{\bf Step 1: Predictor Stochastic/Diffusive Fluxes:}\\ \\
Compute $\Fb_i^n$ and $\nabla\cdot\Fb_i^n$ from $(\rho_i^n,T^n)$ using the supplied {\tt compute\_mass\_fluxdiv} subroutine.
Pass in $\Delta t/2$ as the scaling factor for the random fluxes.
Construct $S^n$ using equation (\ref{eq:S}).\\ \\
{\bf Step 2: Predictor Stokes Solve:}
Generate a random advection velocity by solving the steady Stokes equation with random forcing.
Define $p^* = p^{n-\myhalf} + \delta p$ and $\vb^* = \overline\vb^{n-\myhalf} + \delta\vb$ 
(in these notes the overline indicates the the velocity field has been modified to incorporate
the boundary conditions on the full velocity field after the solve) and solve:
\begin{equation}
\nabla(p^{n-\myhalf} + \delta p) = \mathcal A_0^n(\overline\vb^{n-\myhalf} + \deltab\vb) 
+ \nabla\cdot\underbrace{\sqrt{\frac{2\eta^n k_B T}{\Delta t\Delta V}}\overline\Wb_A^n}_{\Sigmab^{(1)}} + \rho^n\gb,
\end{equation}
\begin{equation}
\nabla\cdot(\overline\vb^{n-\myhalf} + \delta\vb) = S^n,
\end{equation}
which can be written as
\begin{equation}
-\mathcal{A}_0^n\deltab\vb + \nabla\delta p = -\nabla p^{n-\myhalf} + \mathcal{A}_0^n\overline\vb^{n-\myhalf}
+ \nabla\cdot\Sigmab^{(1)} + \rho^n\gb,
\end{equation}
\begin{equation}
-\nabla\cdot\deltab\vb = \nabla\cdot\overline\vb^{n-\myhalf} - S^n.
\end{equation}
{\bf Step 3: Scalar Predictor Midpoint Euler Step}\\ \\
Take a midpoint predictor forward Euler step for $\rho_i$:
\begin{equation}
\rho_i^{*,n+\myhalf} = \rho_i^n + \frac{\Delta t}{2}\nabla\cdot(-\rho_i^n\vb^* + \Fb_i^n).
\end{equation}
Set $\rho^{*,n+\myhalf} = \sum_i\rho_i^{*,n+\myhalf}$.\\ \\
{\bf Step 4: Corrector Stochastic/Diffusive Fluxes:}\\ \\
Compute $\Fb_i^{*,n+\myhalf}$ and 
$\nabla\cdot\Fb_i^{*,n+\myhalf}$ from $(\rho_i^{*,n+\myhalf},T^{*,n+\myhalf})$ using the supplied 
{\tt compute\_mass\_fluxdiv} subroutine.
Pass in $\Delta t/2$ as the scaling factor for the random fluxes.
Construct $S^{*,n+\myhalf}$ using equation (\ref{eq:S}).\\ \\
{\bf Step 5: Corrector Stokes Solve:}\\ \\
Solve a steady Stokes system with $p^{n+\myhalf} = p^* + \delta p$ and $\vb^{n+\myhalf} = \overline\vb^* + \delta\vb$:
\begin{equation}
\nabla(p^* + \delta p) = \mathcal A_0^{*,n+\myhalf}(\overline\vb^* + \deltab\vb) 
+ \nabla\cdot\underbrace{\sqrt{\frac{2\eta^{*,n+\myhalf} k_B T}{\Delta t\Delta V}}\left(\frac{\overline\Wb_A^n + \overline\Wb_B^n}{\sqrt{2}}\right)}_{\Sigmab^{(2)}} + \rho^{*,n+\myhalf}\gb,
\end{equation}
\begin{equation}
\nabla\cdot(\overline\vb^* + \delta\vb) = S^{*,n+\myhalf},
\end{equation}
which can be written as
\begin{equation}
-\mathcal{A}_0^{*,n+\myhalf}\deltab\vb + \nabla\delta p = -\nabla p^* + \mathcal{A}_0^{*,n+\myhalf}\overline\vb^*
+ \nabla\cdot\Sigmab^{(2)} + \rho^{*,n+\myhalf}\gb,
\end{equation}
\begin{equation}
-\nabla\cdot\deltab\vb = \nabla\cdot\overline\vb^* - S^{*,n+\myhalf}.
\end{equation}
Next, define $\vb^{n+\myhalf} = \overline\vb^* + \deltab\vb$ and $p^{n+\myhalf} = p^* + \delta p$.\\ \\
{\bf Step 6: Midpoint Scalar Corrector:}\\ \\
Update the densities and concentrations
\begin{eqnarray}
\rho_i^{n+1} &=& \rho_i^n + \Delta t\left(-\rho_i^{*,n+\myhalf}\vb^{n+\myhalf} + \Fb_i^{*,n+\myhalf}\right).
\end{eqnarray}
Set $\rho^{n+1} = \sum_i\rho_i^{n+1}$.

\clearpage

\section{Inertial Algorithm}
Inertial algorithm description:\\ \\
{\bf Step 0: Initialization:}\\ \\
Begin with an initial guess for velocity, $\vb^{\rm init}$, and pressure, $p^0$.
Then, perform a projection to obtain an initial velocity field, $\vb^0$ that satisfies
\begin{equation}
\nabla\cdot\vb^0 = S^0 \equiv S(\Fb^0),
\end{equation}
where $\Fb_i^0$ and $\nabla\cdot\Fb_i^0$ are computed from $(\rho_i^0,T^0)$ using the 
supplied {\tt compute\_mass\_fluxdiv} subroutine.
For the projection, we solve for $\phi$ and update $\vb^{\rm init}$ as follows:
\begin{equation}
\nabla\cdot\frac{1}{\rho^0}\nabla\phi = \nabla\cdot\vb^{\rm init} - S^0,
\end{equation}
\begin{equation}
\vb^0 = \vb^{\rm init} - \frac{1}{\rho}\nabla\phi.
\end{equation}
{\bf Step 1: Calculate Predictor Diffusive and Stochastic Fluxes}\\ \\
Compute $\Fb_i^n$ and $\nabla\cdot\Fb_i^n$ from $(\rho_i^n,T^n)$ using the supplied 
{\tt compute\_mass\_fluxdiv} subroutine.  Construct $S^n$ using equation (\ref{eq:S}).
Note this step is functionally a null-op since we reuse the result from 
either {\bf Step 0} or {\bf Step 6} from the previous time step.\\ \\
{\bf Step 2: Predictor Euler Step}\\ \\
Using the velocity field from either {\bf Step 0} or {\bf Step 7} from the previous
time step, take a predictor forward Euler step for $\rho_i$:
\begin{equation}
\rho_i^{*,n+1} = \rho_i^n + \Delta t\nabla\cdot\left(-\rho_i^n\vb^n + \Fb^n\right).
\end{equation}
{\bf Step 3: Calculate Corrector Diffusive and Stochastic Fluxes}\\ \\
We reuse the same random numbers, but evaluate the diffusive fluxes and the noise amplitude from the predictor
to compute $\Fb^{*,n+1}$ and $S^{*,n+1}$.
{\bf Step 4: Predictor Crank-Nicolson Step}\\ \\
Define $\vb^{*,n+1} = \overline\vb^n + \deltab\vb, p^{*,n+1} = p^n + \delta p$ (in these notes the overline
indicates the the velocity field has been modified to incorporate the boundary conditions on the
full velocity field after the solve) and solve
for $\deltab\vb$ and $\delta p$:
\begin{eqnarray}
\frac{\rho^{*,n+1}(\overline\vb^n + \deltab\vb) - \rho^n\vb^n}{\Delta t} + \nabla(p^n+\delta p) &=&\nonumber\\
&&\hspace{-1in}\nabla\cdot(-\rho^n\vb^n\vb^n) + \half\left[\mathcal{A}_0^n\vb^n + \mathcal{A}_0^n(\overline\vb^n + \deltab\vb)\right] + \nabla\cdot\underbrace{\sqrt{\frac{2\eta^n k_B T}{\Delta t\Delta V}}\overline\Wb^n}_{\Sigmab^n} + \rho^n\gb,\nonumber\\
\end{eqnarray}
\begin{equation}
\nabla\cdot(\overline\vb^n+\deltab\vb) = S^{*,n+1}.
\end{equation}
We rewrite this system as
\begin{eqnarray}
\left(\frac{\rho^{*,n+1}}{\Delta t} - \half\mathcal{A}_0^{*,n+1}\right)\deltab\vb + \nabla\delta p &=& \frac{\rho^n\vb^n-\rho^{*,n+1}\overline\vb^n}{\Delta t} -\nabla p^n\nonumber\\
&&\hspace{-0.5in}+ \nabla\cdot(-\rho^n\vb^n\vb^n) + \half\mathcal{A}_0^n\vb^n + \half\mathcal{A}_0^n\overline\vb^n + \nabla\cdot\Sigmab^n + \rho^n\gb,\label{eq:CN Vel Pred}
\end{eqnarray}
\begin{equation}
-\nabla\cdot\deltab\vb = \nabla\cdot\overline\vb^n - S^{*,n+1}.
\end{equation}
Relating this to the GMRES solver, we can see that we are solving for 
$(\xb_\vb,x_p) = (\deltab\vb,\delta p)$ with $b_p = \nabla\cdot\overline\vb^n-S^{*,n+1}$ (note the change in sign!) 
and $\bb_\vb$ equal to the right-hand-side of (\ref{eq:CN Vel Pred}).  For the Helmholtz-like operator, 
$\mathcal{A}=\Theta\alpha\mathcal{I} - \mathcal{A}_0$, we have $\Theta=1/\Delta t, \alpha=\rho^{*,n+1}, 
\beta=\eta/2$, and $\gamma=\kappa/2$.
Next, define $\vb^{*,n+1} = \overline\vb^n + \deltab\vb$ and $p^{*,n+1} = p^n + \delta p$.\\ \\
{\bf Step 5: Trapezoidal Scalar Corrector}\\ \\
Update the densities:
\begin{equation}
\rho_i^{n+1} = \half\rho_i^n + \half\left[\rho_i^{*,n+1} + \Delta t\nabla\cdot(-\rho_i^{*,n+1}\vb^{*,n+1} + \Fb^{*,n+1})\right].
\end{equation}
{\bf Step 6: Calculate Diffusive and Stochastic Fluxes}\\ \\
Calculate the fluxes for the next time level using a new set of random numbers to obtain $\Fb^{n+1}$ and $S^{n+1}$.
{\bf Step 7: Corrector Crank-Nicolson Step}\\ \\
Take a corrector step for velocity, using the same random numbers as for the predictor
stage, but average the amplitude of the stochastic flux between time $n$ and $n+1$:
Define $\vb^{n+1} = \overline\vb^{*,n+1} + \deltab\vb$ and $p^{n+1} = p^{*,n+1} + \delta p$ and
solve the following system for $(\deltab\vb,\delta p)$:
\begin{eqnarray}
\frac{\rho^{n+1}(\overline\vb^{*,n+1} + \deltab\vb) - \rho^n\vb^n}{\Delta t} + \nabla(p^{*,n+1}+\delta p) &=& \half\nabla\cdot(-\rho^n\vb^n\vb^n - \rho^{*,n+1}\vb^{*,n+1}\vb^{*,n+1})\nonumber\\
&&\hspace{-1.5in}+ \half\left[\mathcal{A}_0^n\vb^n + \mathcal{A}_0^{n+1}(\overline\vb^{*,n+1} + \deltab\vb)\right]\nonumber\\
&&\hspace{-1.5in}+ \nabla\cdot\underbrace{\half\left(\sqrt{\frac{2\eta^n k_B T}{\Delta t\Delta V}} + \sqrt{\frac{2\eta^{n+1} k_B T}{\Delta t\Delta V}}\right)\overline\Wb^n}_{\Sigmab^{n'}} + \half\left(\rho^n+\rho^{n+1}\right)\gb,
\end{eqnarray}
\begin{equation}
\nabla\cdot(\overline\vb^{*,n+1} + \deltab\vb) = S^{n+1}.
\end{equation}
We rewrite this system as:
\begin{eqnarray}
\left(\frac{\rho^{n+1}}{\Delta t} - \half\mathcal{A}_0^{n+1}\right)\deltab\vb + \nabla\delta p &=& \frac{\rho^n\vb^n-\rho^{n+1}\overline\vb^{*,n+1}}{\Delta t} -\nabla p^n\nonumber\\
&&+ \half\nabla\cdot(-\rho^n\vb^n\vb^n - \rho^{*,n+1}\vb^{*,n+1}\vb^{*,n+1}) + \half(\mathcal{A}_0^n\vb^n + \mathcal{A}_0^{n+1}\overline\vb^{*,n+1} )\nonumber\\
&&+ \nabla\cdot\Sigmab^{n'} + \half\left(\rho^n+\rho^{n+1}\right)\gb,
\end{eqnarray}
\begin{equation}
-\nabla\cdot\deltab\vb = \nabla\cdot\overline\vb^{*,n+1} - S^{n+1}.
\end{equation}

\section{Mixed-Mode Instability}
We test our model by performing mixed mode instability (MMI) simulations to compare to experiments 
(Figures 1(d)-(f) in Carballido-Landieira et al., Physics of Fluids, 2013).  In this ternary mixture
setup we have a heavier solution consisting of a salt solute (KCl) and water sitting upon
a lighter solution consisting of a sucrose solute and water
with an initially flat interface (with optionally a slight random perturbation) in between two glass plates separated
by 0.25mm.  The rate at which the salt solute diffuses into water is approximately 4 times greater than
the rate at which the sugar solute diffuses into water.
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\begin{figure}[hb]
\centering
\includegraphics[width=2in]{mmi}
\label{fig:mmi}
\caption{Caption...}
\end{figure}
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

Parameters
-all units in cgs.
-Domain: 0.8cm $\times$ 0.8cm $\times$ 0.25mm.  Simulation uses 256 $\times$ 256 $\times$ 8 grid cells.
-Periodic in $x$, slip-reservoir in $y$, no-slip walls (glass plates) in $z$.
-Gravity of 981cm/s$^2$ in the downward $y$ direction.
-uses inertial algorithm.  overdamped gives qualitatively similar results but takes gmres a factor of $\sim$4 more
 iterations to converge
-Diffusive CFL more restrictive.  $\Delta t = 6.39 \times 10^{-2}$s $\sigma\Delta x^2/(2*d*D_{\rm max}$, with $\sigma=0.75$ 
 and dimensionality $d=3$.  Run to 1000 time steps ($t\approx 63.9$s).
-Fluid 1 is salt solute, fluid 2 is sucrose solute, and fluid 3 is water with $\overline\rho = (2.81, 1.55, 1.0)$.
 KCl solution on top of sucrose solution, i.e., heavy on top of light.
-molecular masses $1.238\times 10^{-22}, 5.684\times 10^{-22}, 2.99\times 10^{-23}$ g/molecule.
-Maxwell-Stefan diffusion constants, $D_{12} = 4.31826\times 10^{-6}, D_{13} = 1.91\times 10^{-5}, D_{23} = 5.2\times 10^{-6}$.
-viscosity $\eta = 0.01002$ Poise
-limited bilinear BDS advection
-viscous stress tensor formulation ignores bulk viscosity term
-choice of enabling thermal fluctuations (both mass and momentum, even though mass fluctuations 
 don't seem to have any measureable effect)
-Temperature of 293 K.
-Initial conditions: 
 The initial mass fractions (concentrations) in the lower half of the domain are $c_{\rm lo} = (0, 0.1368, 0.8632)$.
 The initial mass fractions (concentrations) in the upper half of the domain are $c_{\rm hi} = (0.0864, 0, 0.9136)$.
 This gives an initial density of 1.058932 g/cm$^3$ on top and 1.051018 g/cm$^3$ on bottom
 Reservoir values set to match these initial conditions.
-choice of discontinuous initial interface or a randomly perturbed initial interface with one $xz$ plane 
 of cells at the centerline randomly perturbed using:
 $c = r c_{\rm lo} + (1-r) c_{\rm hi}$, with $r$ being a random number between 0.9 and 1.0.  This range of random numbers was chosen
 so that the timescales of the pattern/spectra development match a flat initial interface with thermal fluctuations.

\end{document}
