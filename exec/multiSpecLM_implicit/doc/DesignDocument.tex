\documentclass[final]{siamltex}

% for red MarginPars
\usepackage{color}

% for \boldsymbol
\usepackage{amsmath}
\usepackage{latexsym}
\usepackage{graphicx}
\usepackage{geometry}
\usepackage{hyperref}

% total number of floats allowed on a page
\setcounter{totalnumber}{100}

% float page fractions
\renewcommand{\topfraction}{0.9}
\renewcommand{\bottomfraction}{0.9}
\renewcommand{\textfraction}{0.2}

% MarginPar
\setlength{\marginparwidth}{0.75in}
\newcommand{\MarginPar}[1]{\marginpar{\vskip-\baselineskip\raggedright\tiny\sffamily\hrule\smallskip{\color{red}#1}\par\smallskip\hrule}}

% for non-stacked fractions
\newcommand{\sfrac}[2]{\mathchoice
  {\kern0em\raise.5ex\hbox{\the\scriptfont0 #1}\kern-.15em/
   \kern-.15em\lower.25ex\hbox{\the\scriptfont0 #2}}
  {\kern0em\raise.5ex\hbox{\the\scriptfont0 #1}\kern-.15em/
   \kern-.15em\lower.25ex\hbox{\the\scriptfont0 #2}}
  {\kern0em\raise.5ex\hbox{\the\scriptscriptfont0 #1}\kern-.2em/
   \kern-.15em\lower.25ex\hbox{\the\scriptscriptfont0 #2}}
  {#1\!/#2}}

\def\bb {{\bf b}}
\def\Fb {{\bf F}}
\def\vb {{\bf v}}
\def\Wb {{\bf W}}
\def\xb {{\bf x}}

\def\deltab {\boldsymbol{\delta}}
\def\Psib   {\boldsymbol{\Psi}}
\def\Sigmab {\boldsymbol{\Sigma}}

\def\half   {\frac{1}{2}}
\def\myhalf {\sfrac{1}{2}}

\begin{document}

%==========================================================================
% Title
%==========================================================================
\title{Implicit Low Mach Number Multispecies Mixing Notes}

\maketitle

\section{Equations}
Overdetermined equations for the densities:
\begin{eqnarray}
\frac{\partial\rho}{\partial t} &=& -\nabla\cdot(\rho\vb)\\
\frac{\partial\rho_i}{\partial t} &=& -\nabla\cdot(\rho_i\vb) + \nabla\cdot\Fb_i,
\end{eqnarray}
with $\Fb_i$ containing both the diffusive and stochastic mass fluxes.  The equation of state is:
\begin{equation}
\nabla\cdot\vb = \nabla\cdot\left(\sum_i\frac{\Fb_i}{\bar\rho_i}\right) \equiv S\label{eq:S}.
\end{equation}

\clearpage

\section{Overdamped 1RNG Algorithm}
This algorithm is of limited use since it is not formally second-order accurate.  It was
an early test algorithm, and it so happens that the second Stokes solve is a null-op
for the constant-coefficient, incompressible, no gravity case.  But anyway, here it
is for the record.\\ \\
{\bf Step 0: Initialization:}\\ \\
Begin with an initial guess for velocity, $\vb^{-\myhalf}$ (note this only used as a reference state for the GMRES
solve and for computing the right-hand-side for pressure, so it does not have to satisfy any constraint),
and pressure, $p^{-\myhalf}$.\\ \\
{\bf Step 1: Predictor Stochastic/Diffusive Fluxes:}\\ \\
Compute $\Fb_i^n$ and $\nabla\cdot\Fb_i^n$ from $(\rho_i^n,T^n)$
using the supplied {\tt compute\_mass\_fluxdiv} subroutine.
Pass in $\Delta t$ as the scaling factor for the random fluxes.
Construct $S^n$ using equation (\ref{eq:S}).\\ \\
{\bf Step 2: Predictor Stokes Solve:}
Generate a random advection velocity by solving the steady Stokes equation with random forcing.
Define $p^* = p^{n-\myhalf} + \delta p$ and $\vb^* = \overline\vb^{n-\myhalf} + \delta\vb$ 
(in these notes the overline indicates the the velocity field has been modified to incorporate
the boundary conditions on the full velocity field after the solve) and solve:
\begin{equation}
\nabla(p^{n-\myhalf} + \delta p) = \mathcal A_0^n(\overline\vb^{n-\myhalf} + \deltab\vb) + \nabla\cdot\underbrace{\sqrt{\frac{2\eta^n k_B T}{\Delta t\Delta V}}\overline\Wb^n}_{\Sigmab^{(1)}},
\end{equation}
\begin{equation}
\nabla\cdot(\overline\vb^{n-\myhalf} + \delta\vb) = S^n,
\end{equation}
which can be written as
\begin{equation}
-\mathcal{A}_0^n\deltab\vb + \nabla\delta p = -\nabla p^{n-\myhalf} + \mathcal{A}_0^n\overline\vb^{n-\myhalf}
+ \nabla\cdot\Sigmab^{(1)},
\end{equation}
\begin{equation}
-\nabla\cdot\deltab\vb = \nabla\cdot\overline\vb^{n-\myhalf} - S^n.
\end{equation}
{\bf Step 3: Scalar Predictor Midpoint Euler Step}\\ \\
Take a midpoint predictor forward Euler step for $\rho_i$:
\begin{equation}
\rho_i^{*,n+\myhalf} = \rho_i^n + \frac{\Delta t}{2}\nabla\cdot(-\rho_i^n\vb^* + \Fb_i^n).
\end{equation}
Set $\rho^{*,n+\myhalf} = \sum_i\rho_i^{*,n+\myhalf}$.\\ \\
{\bf Step 4: Corrector Stochastic/Diffusive Fluxes:}\\ \\
Compute $\Fb_i^{*,n+\myhalf}$ and 
$\nabla\cdot\Fb_i^{*,n+\myhalf}$ from $(\rho_i^{*,n+\myhalf},T^{*,n+\myhalf})$ using the supplied 
{\tt compute\_mass\_fluxdiv} subroutine.
Pass in $\Delta t/2$ as the scaling factor for the random fluxes.
Construct $S^{*,n+\myhalf}$ using equation (\ref{eq:S}).\\ \\
{\bf Step 5: Corrector Stokes Solve:}\\ \\
Solve a steady Stokes system with $p^{n+\myhalf} = p^* + \delta p$ and $\vb^{n+\myhalf} = \overline\vb^* + \delta\vb$:
\begin{equation}
\nabla(p^* + \delta p) = \mathcal A_0^{*,n+\myhalf}(\overline\vb^* + \deltab\vb) + \nabla\cdot\underbrace{\sqrt{\frac{2\eta^{*,n+\myhalf} k_B T}{\Delta t\Delta V}}\overline\Wb^n}_{\Sigmab^{(2)}},
\end{equation}
\begin{equation}
\nabla\cdot(\overline\vb^* + \delta\vb) = S^{*,n+\myhalf},
\end{equation}
which can be written as
\begin{equation}
-\mathcal{A}_0^{*,n+\myhalf}\deltab\vb + \nabla\delta p = -\nabla p^* + \mathcal{A}_0^{*,n+\myhalf}\overline\vb^*
+ \nabla\cdot\Sigmab^{(2)},
\end{equation}
\begin{equation}
-\nabla\cdot\deltab\vb = \nabla\cdot\overline\vb^* - S^{*,n+\myhalf}.
\end{equation}
Next, define $\vb^{n+\myhalf} = \overline\vb^* + \deltab\vb$ and $p^{n+\myhalf} = p^* + \delta p$.\\ \\
{\bf Step 6: Midpoint Scalar Corrector:}\\ \\
Update the densities and concentrations
\begin{eqnarray}
\rho_i^{n+1} &=& \rho_i^n + \Delta t\left(-\rho_i^{*,n+\myhalf}\vb^{n+\myhalf} + \Fb_i^{*,n+\myhalf}\right).
\end{eqnarray}
Set $\rho^{n+1} = \sum_i\rho_i^{n+1}$.

\clearpage

\section{Overdamped 2RNG Algorithm}
This is our preferred algorithm.\\ \\
{\bf Step 0: Initialization:}\\ \\
Begin with an initial guess for velocity, $\vb^{-\myhalf}$ (note this only used as a reference state for the GMRES
solve and for computing the right-hand-side for pressure, so it does not have to satisfy any constraint),
and pressure, $p^{-\myhalf}$.\\ \\
{\bf Step 1: Predictor Stochastic/Diffusive Fluxes:}\\ \\
Compute $\Fb_i^n$ and $\nabla\cdot\Fb_i^n$ from $(\rho_i^n,T^n)$ using the supplied {\tt compute\_mass\_fluxdiv} subroutine.
Pass in $\Delta t/2$ as the scaling factor for the random fluxes.
Construct $S^n$ using equation (\ref{eq:S}).\\ \\
{\bf Step 2: Predictor Stokes Solve:}
Generate a random advection velocity by solving the steady Stokes equation with random forcing.
Define $p^* = p^{n-\myhalf} + \delta p$ and $\vb^* = \overline\vb^{n-\myhalf} + \delta\vb$ 
(in these notes the overline indicates the the velocity field has been modified to incorporate
the boundary conditions on the full velocity field after the solve) and solve:
\begin{equation}
\nabla(p^{n-\myhalf} + \delta p) = \mathcal A_0^n(\overline\vb^{n-\myhalf} + \deltab\vb) 
+ \nabla\cdot\underbrace{\sqrt{\frac{2\eta^n k_B T}{\Delta t\Delta V}}\overline\Wb_A^n}_{\Sigmab^{(1)}},
\end{equation}
\begin{equation}
\nabla\cdot(\overline\vb^{n-\myhalf} + \delta\vb) = S^n,
\end{equation}
which can be written as
\begin{equation}
-\mathcal{A}_0^n\deltab\vb + \nabla\delta p = -\nabla p^{n-\myhalf} + \mathcal{A}_0^n\overline\vb^{n-\myhalf}
+ \nabla\cdot\Sigmab^{(1)},
\end{equation}
\begin{equation}
-\nabla\cdot\deltab\vb = \nabla\cdot\overline\vb^{n-\myhalf} - S^n.
\end{equation}
{\bf Step 3: Scalar Predictor Midpoint Euler Step}\\ \\
Take a midpoint predictor forward Euler step for $\rho_i$:
\begin{equation}
\rho_i^{*,n+\myhalf} = \rho_i^n + \frac{\Delta t}{2}\nabla\cdot(-\rho_i^n\vb^* + \Fb_i^n).
\end{equation}
Set $\rho^{*,n+\myhalf} = \sum_i\rho_i^{*,n+\myhalf}$.\\ \\
{\bf Step 4: Corrector Stochastic/Diffusive Fluxes:}\\ \\
Compute $\Fb_i^{*,n+\myhalf}$ and 
$\nabla\cdot\Fb_i^{*,n+\myhalf}$ from $(\rho_i^{*,n+\myhalf},T^{*,n+\myhalf})$ using the supplied 
{\tt compute\_mass\_fluxdiv} subroutine.
Pass in $\Delta t/2$ as the scaling factor for the random fluxes.
Construct $S^{*,n+\myhalf}$ using equation (\ref{eq:S}).\\ \\
{\bf Step 5: Corrector Stokes Solve:}\\ \\
Solve a steady Stokes system with $p^{n+\myhalf} = p^* + \delta p$ and $\vb^{n+\myhalf} = \overline\vb^* + \delta\vb$:
\begin{equation}
\nabla(p^* + \delta p) = \mathcal A_0^{*,n+\myhalf}(\overline\vb^* + \deltab\vb) 
+ \nabla\cdot\underbrace{\sqrt{\frac{2\eta^{*,n+\myhalf} k_B T}{\Delta t\Delta V}}\left(\frac{\overline\Wb_A^n + \overline\Wb_B^n}{\sqrt{2}}\right)}_{\Sigmab^{(2)}},
\end{equation}
\begin{equation}
\nabla\cdot(\overline\vb^* + \delta\vb) = S^{*,n+\myhalf},
\end{equation}
which can be written as
\begin{equation}
-\mathcal{A}_0^{*,n+\myhalf}\deltab\vb + \nabla\delta p = -\nabla p^* + \mathcal{A}_0^{*,n+\myhalf}\overline\vb^*
+ \nabla\cdot\Sigmab^{(2)},
\end{equation}
\begin{equation}
-\nabla\cdot\deltab\vb = \nabla\cdot\overline\vb^* - S^{*,n+\myhalf}.
\end{equation}
Next, define $\vb^{n+\myhalf} = \overline\vb^* + \deltab\vb$ and $p^{n+\myhalf} = p^* + \delta p$.\\ \\
{\bf Step 6: Midpoint Scalar Corrector:}\\ \\
Update the densities and concentrations
\begin{eqnarray}
\rho_i^{n+1} &=& \rho_i^n + \Delta t\left(-\rho_i^{*,n+\myhalf}\vb^{n+\myhalf} + \Fb_i^{*,n+\myhalf}\right).
\end{eqnarray}
Set $\rho^{n+1} = \sum_i\rho_i^{n+1}$.

\clearpage

\section{Inertial Algorithm}
Inertial algorithm description:\\ \\
{\bf Step 0: Initialization:}\\ \\
Begin with an initial guess for velocity, $\vb^{\rm init}$, and pressure, $p^0$.
Then, perform a projection to obtain an initial velocity field, $\vb^0$ that satisfies
\begin{equation}
\nabla\cdot\vb^0 = S^0 \equiv S(\Fb^0),
\end{equation}
where $\Fb_i^0$ and $\nabla\cdot\Fb_i^0$ are computed from $(\rho_i^0,T^0)$ using the 
supplied {\tt compute\_mass\_fluxdiv} subroutine.
For the projection, we solve for $\phi$ and update $\vb^{\rm init}$ as follows:
\begin{equation}
\nabla\cdot\frac{1}{\rho^0}\nabla\phi = \nabla\cdot\vb^{\rm init} - S^0,
\end{equation}
\begin{equation}
\vb^0 = \vb^{\rm init} - \frac{1}{\rho}\nabla\phi.
\end{equation}
{\bf Step 1: Calculate Predictor Diffusive and Stochastic Fluxes}\\ \\
Compute $\Fb_i^n$ and $\nabla\cdot\Fb_i^n$ from $(\rho_i^n,T^n)$ using the supplied 
{\tt compute\_mass\_fluxdiv} subroutine.  Construct $S^n$ using equation (\ref{eq:S}).
Note this step is functionally a null-op since we reuse the result from 
either {\bf Step 0} or {\bf Step 6} from the previous time step\\ \\
{\bf Step 2: Predictor Euler Step}\\ \\
{\bf Step 3: Calculate Corrector Diffusive and Stochastic Fluxes}\\ \\
{\bf Step 4: Predictor Crank-Nicolson Step}\\ \\
{\bf Step 5: Trapezoidal Scalar Corrector}\\ \\
{\bf Step 6: Calculate Diffusive and Stochastic Fluxes}\\ \\
{\bf Step 7: Corrector Crank-Nicolson Step}\\ \\


\clearpage

{\bf Step 1: Predictor Stochastic/Diffusive Fluxes:}\\ \\
{\bf Step 2: Predictor Stokes Solve:}
Generate a random advection velocity by solving the steady Stokes equation with random forcing.
Define $p^* = p^{n-\myhalf} + \delta p$ and $\vb^* = \overline\vb^{n-\myhalf} + \delta\vb$ 
(in these notes the overline indicates the the velocity field has been modified to incorporate
the boundary conditions on the full velocity field after the solve) and solve:
\begin{equation}
\nabla(p^{n-\myhalf} + \delta p) = \mathcal A_0^n(\overline\vb^{n-\myhalf} + \deltab\vb) 
+ \nabla\cdot\underbrace{\sqrt{\frac{2\eta^n k_B T}{\Delta t\Delta V}}\overline\Wb_A^n}_{\Sigmab^{(1)}},
\end{equation}
\begin{equation}
\nabla\cdot(\overline\vb^{n-\myhalf} + \delta\vb) = S^n,
\end{equation}
which can be written as
\begin{equation}
-\mathcal{A}_0^n\deltab\vb + \nabla\delta p = -\nabla p^{n-\myhalf} + \mathcal{A}_0^n\overline\vb^{n-\myhalf}
+ \nabla\cdot\Sigmab^{(1)},
\end{equation}
\begin{equation}
-\nabla\cdot\deltab\vb = \nabla\cdot\overline\vb^{n-\myhalf} - S^n.
\end{equation}
{\bf Step 3: Scalar Predictor Midpoint Euler Step}\\ \\
Take a midpoint predictor forward Euler step for $\rho_i$:
\begin{equation}
\rho_i^{*,n+\myhalf} = \rho_i^n + \frac{\Delta t}{2}\nabla\cdot(-\rho_i^n\vb^* + \Fb_i^n).
\end{equation}
Set $\rho^{*,n+\myhalf} = \sum_i\rho_i^{*,n+\myhalf}$.\\ \\
{\bf Step 4: Corrector Stochastic/Diffusive Fluxes:}\\ \\
Compute $\Fb_i^{*,n+\myhalf}$ and 
$\nabla\cdot\Fb_i^{*,n+\myhalf}$ from $(\rho_i^{*,n+\myhalf},T^{*,n+\myhalf})$ using the supplied 
{\tt compute\_mass\_fluxdiv} subroutine.
Pass in $\Delta t/2$ as the scaling factor for the random fluxes.
Construct $S^{*,n+\myhalf}$ using equation (\ref{eq:S}).\\ \\
{\bf Step 5: Corrector Stokes Solve:}\\ \\
Solve a steady Stokes system with $p^{n+\myhalf} = p^* + \delta p$ and $\vb^{n+\myhalf} = \overline\vb^* + \delta\vb$:
\begin{equation}
\nabla(p^* + \delta p) = \mathcal A_0^{*,n+\myhalf}(\overline\vb^* + \deltab\vb) 
+ \nabla\cdot\underbrace{\sqrt{\frac{2\eta^{*,n+\myhalf} k_B T}{\Delta t\Delta V}}\left(\frac{\overline\Wb_A^n + \overline\Wb_B^n}{\sqrt{2}}\right)}_{\Sigmab^{(2)}},
\end{equation}
\begin{equation}
\nabla\cdot(\overline\vb^* + \delta\vb) = S^{*,n+\myhalf},
\end{equation}
which can be written as
\begin{equation}
-\mathcal{A}_0^{*,n+\myhalf}\deltab\vb + \nabla\delta p = -\nabla p^* + \mathcal{A}_0^{*,n+\myhalf}\overline\vb^*
+ \nabla\cdot\Sigmab^{(2)},
\end{equation}
\begin{equation}
-\nabla\cdot\deltab\vb = \nabla\cdot\overline\vb^* - S^{*,n+\myhalf}.
\end{equation}
Next, define $\vb^{n+\myhalf} = \overline\vb^* + \deltab\vb$ and $p^{n+\myhalf} = p^* + \delta p$.\\ \\
{\bf Step 6: Midpoint Scalar Corrector:}\\ \\
Update the densities and concentrations
\begin{eqnarray}
\rho_i^{n+1} &=& \rho_i^n + \Delta t\left(-\rho_i^{*,n+\myhalf}\vb^{n+\myhalf} + \Fb_i^{*,n+\myhalf}\right).
\end{eqnarray}
Set $\rho^{n+1} = \sum_i\rho_i^{n+1}$.
\end{document}
